<!DOCTYPE html>
<html>
	<head>
		<title>Email ComTrends</title>
        <link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	
	<body>
		<h1>Email Communication Trends</h1>
		<br>
		<p>
			<label>Search: </label>
			<input id = "countryName" type = "text" onkeyup = "prsButton(event,this.value)">
			<button id = "gdpButton" type = "button" onclick = "getGDP()">GO</button>
            <label>Start date: </label>
            <input id = "countryName" type = "text" onkeyup = "prsButton(event,this.value)">
            <label>End date: </label>
            <input id = "countryName" type = "text" onkeyup = "prsButton(event,this.value)">
            <label>Interval: </label>
            <input id = "countryName" type = "text" onkeyup = "prsButton(event,this.value)">
			<b><span id = "result"></span></b>
		</p>
		<div id = "cList">
	        <h2>SideBox</h2>
	        <br>
	        <ul id = "list"></ul>
	    </div>
	    <div id = "tooltip">
	    	<span id = "countryName"></span><br>
	    	<span id = "countryGDP"></span><br>
	    	<span id = "countryEase"></span>
	    </div>
	    <div id = "Info"> x@enron.com </div>
        <!-- <svg id = "viz2"></svg> -->
	    <!-- <svg id = "viz"><canvas id = "legendCanvas" width = "800" height = "300" style = "border:5px solid #d3d3d3;"></canvas></svg> -->
        <svg id = "viz"><svg id = "legend"></svg></svg>
	</body>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<script>
        var startDate;
        var endDate;
        var data_obj;
        var user_list;
        var email_dict;
        var user_data_dict;
        var year_month_pairs;
        
        d3.json("data.json", function(data) {
            data_obj = data;
            user_list = data_obj.user_list;
            email_dict = data_obj.emails;
            user_data_dict = data_obj.user_data;
            startDate = data_obj.start_date;
            endDate = data_obj.end_date;
//            console.log(user_data_dict);
            year_month_pairs = data_obj.year_month_pairs;
        });

		function prsButton(event, value){
			if (event.keyCode == 13)
				document.getElementById('gdpButton').click();

			Controler.filter(value)
		}

		function getGDP(){
			var x = document.getElementById("countryName").value;

			var res = Controler.data.filter(function(d) {
                return d.name === x;
            })

            if(res.length === 0) {
                alert("No Country found for: " + x)
            } else {
				document.getElementById("result").innerHTML = x + ": $" + res[0].GDP;
                //d3.select("#result").html(value + ": $" + result[0].GDP);
            }
		}

        Array.prototype.contains = function(v) {
            for(var i = 0; i < this.length; i++) {
                if(this[i] === v) return true;
            }
            return false;
        };

		var Dispatcher = {
            add: function(view) {
                if(!this.subscribers) {
                    this.subscribers = [];
                }
                this.subscribers.push(view);
            },
            notify: function(type, payload) {
                this.subscribers.forEach(function(s) {
                    s[type](payload);
                });
            }
        }

        var emails = [
            { "name": "a@enron.com", "endDate": "2015-11-30", "nSent": 10, "nReceived": 5, "sentEmails": "Hi", "receivedEmails": "Hello", },
            { "name": "a@enron.com", "endDate": "2015-11-29", "nSent": 5, "nReceived": 2, "sentEmails": "Hi", "receivedEmails": "Hello", },
            { "name": "a@enron.com", "endDate": "2015-11-27", "nSent": 7, "nReceived": 6, "sentEmails": "Hi", "receivedEmails": "Hello", },
            { "name": "b@enron.com", "endDate": "2015-11-30", "nSent": 9, "nReceived": 10, "sentEmails": "Hi", "receivedEmails": "Hello", },
            { "name": "hello@enron.com", "endDate": "2015-11-30", "nSent": 3, "nReceived": 8, "sentEmails": "Hi", "receivedEmails": "Hello", },
            { "name": "b@enron.com", "endDate": "2015-11-29", "nSent": 1, "nReceived": 3, "sentEmails": "Hi", "receivedEmails": "Hello", },
        ];

        var Controler = {
            loadData: function() {
            	var self = this;
    //             d3.csv("/data.csv", function(result){
				// 	self.data = result.map(function(d){
		  //               return {
		  //                   name: d.Country,
		  //                   GDP: +d['GDP per Capita'].replace("$", "").replace(",", ""),
		  //                   Ease: +d['Ease of Business'],
		  //                   Year: new Date(d.Year).getFullYear() //firefox works with + 100
		  //               }
		  //           })

		  //           self.data = self.data.filter(function(d) {
		  //               return d.Year == 2012;
		  //           })

		  //           self.data = self.data.filter(function(d) {
		  //               return d.Ease > 0;
		  //           })
		            
		  //           self.data.sort(function(a, b){
		  //               return d3.ascending(a.name, b.name);
		  //           });

		  //           //console.log(self.data);

		  //           Dispatcher.notify('dataUpdated', self.data);
				// });
                self.data = emails;
                // emails[0]['id'] = 3;
                // console.log(MainVis.width);
                //console.log(emails[0]['name']);






                if (self.data.length != 0) {

                    var arr = [];
                    var name = self.data[0]['name'];
                    //console.log(self.data[0]['name']);
                    arr.push(name);
                    var n = 1;
                    for (var i = 1; i < self.data.length; i++) {
                        if (!arr.contains(self.data[i]['name'])) {
                            arr.push(self.data[i]['name']);
                            n++;
                        };
                    };

                };
                
                for (var i = 0; i < self.data.length; i++) {
                    for (var j = 0; j < n; j++) {
                        if (self.data[i]['name'] == arr[j] ) {
                            self.data[i]['id'] = j;
                            // self.data[i]['height'] = (MainVis.height - 90)/n*j+60;
                            self.data[i]['height'] = (MainVis.height - (MainVis.safetyH + MainVis.safetyLow))/n*j+MainVis.safetyH;
                            break;
                        };
                    };
                };


                console.log(self.data);











                Dispatcher.notify('dataUpdated', self.data);
            },
            remove: function(idx) {
                this.data.splice(idx, 1);
                Dispatcher.notify('dataUpdated', this.data);
            },
            filter: function(value) {
                var dt = this.data.filter(function(d) {
                    return d.name.toLowerCase().indexOf(value.toLowerCase()) > -1;
                });
                Dispatcher.notify('dataUpdated', dt);
            }
        }

		var SideBar = {
            init: function() {
                this.list = d3.select("#list");
            },
            getElement: function(d) {
                return this.list.selectAll("li").filter(function(e) { return d.name == e.name });
            },
            dataUpdated: function(mydata) {
                var selection = this.list.selectAll("li").data(mydata, function(d) { return d.name; });
                
                selection.enter().append("li").text(function(d) { return d.name; })
                    .on('mouseover', function(d) {
                        Dispatcher.notify('onHighlight', d);
                    }).on('mouseout', function(d) {
                        Dispatcher.notify('onUnHighlight', d);
                    }).on('click', function(d) {
				        d3.select("#Info").text(d.name + ' - GDP: $' + d.GDP + ' - Ease: ' + d.Ease);
				    });
                
                selection.exit().remove();
            },
            onHighlight: function(d) {
                this.list.selectAll("li")
                    .classed('highlighted', function(e) { return d.name == e.name })
            },
            onUnHighlight: function(d) {
                this.list.selectAll("li")
                    .classed('highlighted', false) 
            }
        }

        var MainVis = {
            init: function() {
                this.width = 1000;
                this.height = 400;
                d3.select("#viz").attr("width", this.width);
                d3.select("#viz").attr("height", this.height);
                

                this.scaleX = d3.time.scale();
                // this.scaleX = d3.scale.linear();
                //this.scaleY = d3.scale.linear();
                
                this.legend = 200;
                this.range = 650;
                this.safetyL = 10;
                this.safetyR = 40;
                this.safetyLow = 30;
                this.safetyH = 50;
                this.scaleX.range([this.safetyL, this.range - this.safetyR]);
                //this.scaleY.range([10, 370]);
                //this.scaleY.range([0, 400]);
                
                this.xAxis = d3.svg.axis()
                .scale(this.scaleX)
                .orient("bottom")
                .ticks(d3.time.days, 1)
                .tickFormat(d3.time.format('%a %d'))
                .tickSize(0);
                //this.yAxis = d3.svg.axis().scale(this.scaleY).orient("left");
                
                this.swift = this.width - this.range - this.legend;
                this.xAxisGroup = d3.select("#viz").append("g")
                    .attr("transform", "translate(" + this.swift + ", " + (this.height-this.safetyLow) + ")" )
                    
                // this.yAxisGroup = d3.select("#viz").append("g")
                //     .attr("transform", "translate(10, 0)" )
                    
                
            },
            dataUpdated: function(mydata) {
                var self = this;



                // mydata.forEach(function(d) {
                //     console.log(d.name);
                // });

                var selection2 = d3.select("#viz") 
                    //.selectAll("g")
                    .selectAll("line")
                    //.data(mydata, function(d) { return d.name; })
                    .data(mydata, function(d) { return d.name; })



                var entry = selection2.enter().append("g");

                    entry.append("line").attr({
                        x1: self.swift + self.safetyL,
                        y1: function(d) { return d.height },//{ k1++; return (self.height-40)/n*k1+10; },
                        x2: self.swift + self.range - self.safetyR,
                        y2: function(d) { return d.height } //{ k2++; return (self.height-40)/n*k2+10; }
                    });



                // var title = selection2.enter().append("g")
                //         // .style("text-anchor", "start")
                //         .attr("transform", "translate(0," + function(d) { return d.height; } + ")");

                    entry.append("text")
                        .attr({
                            x: this.swift,
                            y: function(d) { return d.height },
                        })
                        .style("text-anchor", "end")
                        .text(function(d) { return d.name; });


                // .domain([new Date(data[0].date), d3.time.day.offset(new Date(data[data.length - 1].date), 1)])

                
                this.scaleX.domain([ new Date(startDate), new Date(endDate) ]);
                // this.scaleX.domain([ new Date(d3.min(mydata, function(d) { return d.endDate; })), d3.time.day.offset(new Date(d3.max(mydata, function(d) { return d.endDate; })), 1) ]);
                // this.scaleX.domain([ new Date(d3.min(mydata, function(d) { return d.endDate; })), new Date(d3.max(mydata, function(d) { return d.endDate; })) ]);

                // this.scaleX.domain([0, d3.max(mydata, function(d) { return d.GDP; })]);
                // this.scaleY.domain([d3.max(mydata, function(d) { return d.Ease; }), 0]);

                this.xAxisGroup.transition().call(this.xAxis);
                //this.yAxisGroup.transition().call(this.yAxis);
                
                // var selection = selection2
                var selection = d3.select("#viz") 
                    .selectAll("circle")
                    .data(mydata)
                    
				selection.enter().append("circle");

				selection
				    .on('mouseover', function(d) {
				        Dispatcher.notify('onHighlight', d);    
				    }).on('mouseout', function(d) {
				        Dispatcher.notify('onUnHighlight', d);
				    }).on('click', function(d) {
				        d3.select("#Info").text(d.name + ' - GDP: $' + d.GDP + ' - Ease: ' + d.Ease);
				    }).on('contextmenu', function(d, i){
				        d3.event.preventDefault();
				        Dispatcher.notify('onUnHighlight', d);
				        d3.select("#tooltip").style({
				            'display': 'none'
				        });

				        Controler.remove(i);
				    });
                
                selection.exit().remove();
                
                selection.transition().attr({
                    r: function(d) { return d.nSent + d.nReceived },
                    // r: function(d) { return Math.sqrt((d.nSent + d.nReceived)/Math.PI) },
                    cx: function(d) { return self.swift + self.scaleX(new Date(d.endDate)); },
                    cy: function(d) { return  d.height; }
                });
                

                var maxR = mydata[0].nSent + mydata[0].nReceived;
                // var maxR = Math.sqrt( (mydata[0].nSent + mydata[0].nReceived) / Math.PI );
                var minR = mydata[0].nSent + mydata[0].nReceived;
                // var minR = Math.sqrt( (mydata[0].nSent + mydata[0].nReceived) / Math.PI );
                for (var i = 1; i < mydata.length; i++) {
                    var r = mydata[i].nSent + mydata[i].nReceived;
                    // var r = Math.sqrt( (mydata[i].nSent + mydata[i].nReceived) / Math.PI );
                    if (r > maxR) { maxR = r; };
                    if (r < minR) { minR = r; };
                };

                console.log(minR);
                console.log(maxR);

                var rSize = 3;
                var rMargin = 15;
                
                // var r = [ { "radius": minR, "height": (self.safetyH + minR), } ];
                var r = [ { "radius": minR, "height": (self.height-self.safetyLow - minR), } ];

                for (var i = 1; i < rSize; i++) {
                    r.push({ "radius": Math.ceil(minR + ((maxR-minR) / (rSize - 1)) * i) });
                    // r[i].height = r[i-1].height + r[i-1].radius + rMargin + r[i].radius;
                    r[i].height = r[i-1].height - r[i-1].radius - rMargin - r[i].radius;
                };

                var rectW = 5*maxR;
                var rectHl = r[0].height+r[0].radius+rMargin;
                var rectHh = r[rSize-1].height-r[rSize-1].radius-rMargin;
                var rectH = rectHl - rectHh;
                d3.select("#legend").append("rect")
                    .attr("x", self.width - self.legend*3/4 - rectW*2/5)
                    .attr("y", rectHh)
                    .attr("width", rectW)
                    .attr("height", rectH)
                    .style("fill", "none")
                    .style("stroke", "eeeeee")
                    .style("stroke-width", "2")

                var legend = d3.select("#legend").selectAll("circles").data(r);

                var cx = self.width - self.legend*3/4;
                legend.enter().append("circle")
                    .attr("r", function (d) { return d.radius; })
                    // .attr("r", function (d) { return Math.PI*Math.pow(d.radius,2); })
                    .attr("cx", cx) //- 2*maxR
                    .attr("cy", function (d) { return d.height; });
                    // .style("fill", "red");

                legend.enter().append("text")
                    .attr("x", cx + 3/2*maxR)
                    .attr("y", function (d) { return d.height+4; })
                    .style("font-size", "70%")
                    .text(function (d) { console.log(d.radius); return d.radius; });


                
            },
            getItem: function(d) {
                return d3.select("#viz").selectAll("circle").filter(function(e){
                    return d.name == e.name;
                });
            },
            onHighlight: function(d){
                this.getItem(d).attr("r", 10);
                this.getItem(d).style({fill: "orange", opacity: 1});

                var tooltip = d3.select("#tooltip");
		    	tooltip.select("#countryName").text(d.name);
		    	tooltip.select("#countryGDP").text("GDP: $" + d.GDP);
		    	tooltip.select("#countryEase").text("Ease: " + d.Ease);

		    	tooltip.style({
		    		'display': "block",
		    		'top': d3.event.y + 20 + 'px',
		    		'left': d3.event.x + 10 + 'px'
		    	});
            },
            onUnHighlight: function(d){
                this.getItem(d).attr("r", 5);
                this.getItem(d).style({fill: "red", opacity: 0.5});

                d3.select("#tooltip").style({
                    'display': 'none'
                });
            }
        };

		SideBar.init();
        MainVis.init();
        Dispatcher.add(SideBar);
        Dispatcher.add(MainVis);
        Controler.loadData();
	</script>
</html>
